<!DOCTYPE html>
{% load static %}
<html>
<head>
    <meta charset="utf-8" />
    <title>Django</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f4f4f4;
            margin: 120px;
            padding: 0;
            height: 100vh;
        }

        form {
            width: 30%
        }
    </style>
    <script>
                document.addEventListener('DOMContentLoaded', () => {
            // Используем roomId, переданный из Django шаблона
            const socket = new WebSocket(`ws://${window.location.host}/ws/room/${roomId}/`);

            socket.addEventListener('open', () => {
                console.log('WebSocket connection established');
            });

            socket.addEventListener('message', (e) => {
                const data = JSON.parse(e.data);
                console.log('Received data:', data);

                if (data.participants) {
                    updateParticipants(data.participants);
                } else {
                    console.warn('No participants data received');
                }

                if (data.votes) {
                    updateVotes(data.votes);
                } else {
                    console.warn('No votes data received');
                }
            });

            socket.addEventListener('error', (e) => {
                console.error('WebSocket error:', e);
            });

            socket.addEventListener('close', () => {
                console.error('WebSocket connection closed unexpectedly');
            });

            const refreshButton = document.getElementById('refresh-participants-btn');
            if (refreshButton) {
                refreshButton.addEventListener('click', () => {
                    console.log('Refresh button clicked');
                    socket.send(JSON.stringify({ action: 'refresh_participants' }));
                });
            } else {
                console.error('Refresh button not found');
            }

            const voteForm = document.getElementById('vote-form');
            if (voteForm) {
                voteForm.addEventListener('submit', (event) => {
                    event.preventDefault();

                    const userId = document.getElementById('user-id').value;
                    const voteValue = document.getElementById('vote-value').value;

                    console.log('Submitting vote:', { userId, voteValue });

                    socket.send(JSON.stringify({
                        action: 'submit_vote',
                        user_id: userId,
                        vote: voteValue
                    }));
                });
            } else {
                console.error('Vote form not found');
            }

            function updateParticipants(participants) {
                const participantsList = document.getElementById('participants-list');
                participantsList.innerHTML = '';

                if (!Array.isArray(participants)) {
                    console.error('Invalid participants data:', participants);
                    return;
                }

                participants.forEach(({ username, role, status }) => {
                    const li = document.createElement('li');
                    li.textContent = `${username} (${role}): ${status}`;
                    participantsList.appendChild(li);
                });
            }

            function updateVotes(votes) {
                const votesList = document.getElementById('votes-list');
                votesList.innerHTML = ''; // Очистить старые данные

                if (typeof votes !== 'object' || votes === null) {
                    console.error('Invalid votes data:', votes);
                    return;
                }

                for (const [username, vote] of Object.entries(votes)) {
                    const p = document.createElement('p');
                    p.textContent = `${username}: ${vote}`;
                    votesList.appendChild(p);
                }
            }
        });
    </script>
</head>
<body>
    <h1>Web Socket Test Page</h1>

    <button class="btn btn-dark" id="refresh-participants-btn">Refresh Participants</button>

    <ul id="participants-list"></ul>
    <ul id="votes-list"></ul>

    <h2>Submit Vote</h2>
    <form id="vote-form">
        <div class="input-group">
            <input type="text" id="user-id" name="user-id" class="form-control" placeholder="User ID">
            <input type="number" id="vote-value" name="vote-value"  class="form-control" placeholder="Vote Value">
            <button class="btn btn-dark" type="submit">Submit Vote</button>
        </div>
    </form>
    <!-- Передаем room_id в качестве глобальной переменной -->
    <script>
        const roomId = "{{ room_id }}";  // Используем переменную room_id из Django шаблона
    </script>
<!--    &lt;!&ndash; Подключение JavaScript &ndash;&gt;-->
<!--    <script src="{% static 'js/main.js' %}"></script>-->
</body>
</html>
